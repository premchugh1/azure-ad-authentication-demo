# ğŸ” Azure AD Authentication - Sequence Diagram

## Traditional Sequence Diagram (ASCII Format)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚          â”‚ React   â”‚          â”‚ Azure   â”‚          â”‚ Azure   â”‚          â”‚  JWKS   â”‚
â”‚ Browser â”‚          â”‚   SPA   â”‚          â”‚   AD    â”‚          â”‚Functionsâ”‚          â”‚Endpoint â”‚
â”‚         â”‚          â”‚(MSAL.js)â”‚          â”‚  (IDP)  â”‚          â”‚   API   â”‚          â”‚         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚  1. Navigate       â”‚                     â”‚                     â”‚                     â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 2. Initialize MSAL  â”‚                     â”‚                     â”‚
     â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                     â”‚                     â”‚
     â”‚                    â”‚        â”‚            â”‚                     â”‚                     â”‚
     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 3. Check Cached     â”‚                     â”‚                     â”‚
     â”‚                    â”‚    Tokens           â”‚                     â”‚                     â”‚
     â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                     â”‚                     â”‚
     â”‚                    â”‚        â”‚            â”‚                     â”‚                     â”‚
     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚  4. Show UI        â”‚                     â”‚                     â”‚                     â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                     â”‚                     â”‚                     â”‚
     â”‚  (Login Button)    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚  5. Click "Login"  â”‚                     â”‚                     â”‚                     â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 6. Generate PKCE    â”‚                     â”‚                     â”‚
     â”‚                    â”‚    code_verifier    â”‚                     â”‚                     â”‚
     â”‚                    â”‚    code_challenge   â”‚                     â”‚                     â”‚
     â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                     â”‚                     â”‚
     â”‚                    â”‚        â”‚            â”‚                     â”‚                     â”‚
     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 7. Build Auth URL   â”‚                     â”‚                     â”‚
     â”‚                    â”‚    with PKCE        â”‚                     â”‚                     â”‚
     â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                     â”‚                     â”‚
     â”‚                    â”‚        â”‚            â”‚                     â”‚                     â”‚
     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚  8. Redirect to Azure AD                 â”‚                     â”‚                     â”‚
     â”‚  (with code_challenge)                   â”‚                     â”‚                     â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚  9. Show Login Page                      â”‚                     â”‚                     â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚  10. Enter Credentials                   â”‚                     â”‚                     â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚ 11. Authenticate    â”‚                     â”‚
     â”‚                    â”‚                     â”‚     Verify MFA      â”‚                     â”‚
     â”‚                    â”‚                     â”‚     Check Consent   â”‚                     â”‚
     â”‚                    â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                     â”‚
     â”‚                    â”‚                     â”‚        â”‚            â”‚                     â”‚
     â”‚                    â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚ 12. Generate Code   â”‚                     â”‚
     â”‚                    â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                     â”‚
     â”‚                    â”‚                     â”‚        â”‚            â”‚                     â”‚
     â”‚                    â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚  13. Redirect with Auth Code             â”‚                     â”‚                     â”‚
     â”‚      (code + state)                      â”‚                     â”‚                     â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚  14. Callback URL  â”‚                     â”‚                     â”‚                     â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 15. Extract Code    â”‚                     â”‚                     â”‚
     â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                     â”‚                     â”‚
     â”‚                    â”‚        â”‚            â”‚                     â”‚                     â”‚
     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 16. POST /token     â”‚                     â”‚                     â”‚
     â”‚                    â”‚     (code +         â”‚                     â”‚                     â”‚
     â”‚                    â”‚     code_verifier)  â”‚                     â”‚                     â”‚
     â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚ 17. Verify PKCE     â”‚                     â”‚
     â”‚                    â”‚                     â”‚     SHA256(verifier)â”‚                     â”‚
     â”‚                    â”‚                     â”‚     == challenge    â”‚                     â”‚
     â”‚                    â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                     â”‚
     â”‚                    â”‚                     â”‚        â”‚            â”‚                     â”‚
     â”‚                    â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚ 18. Generate Tokens â”‚                     â”‚
     â”‚                    â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                     â”‚
     â”‚                    â”‚                     â”‚        â”‚            â”‚                     â”‚
     â”‚                    â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 19. Return Tokens   â”‚                     â”‚                     â”‚
     â”‚                    â”‚     access_token    â”‚                     â”‚                     â”‚
     â”‚                    â”‚     id_token        â”‚                     â”‚                     â”‚
     â”‚                    â”‚     refresh_token   â”‚                     â”‚                     â”‚
     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 20. Cache Tokens    â”‚                     â”‚                     â”‚
     â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                     â”‚                     â”‚
     â”‚                    â”‚        â”‚            â”‚                     â”‚                     â”‚
     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 21. Parse ID Token  â”‚                     â”‚                     â”‚
     â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                     â”‚                     â”‚
     â”‚                    â”‚        â”‚            â”‚                     â”‚                     â”‚
     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚  22. Show Logged Inâ”‚                     â”‚                     â”‚                     â”‚
     â”‚      (User Name)   â”‚                     â”‚                     â”‚                     â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚  23. Click "Call   â”‚                     â”‚                     â”‚                     â”‚
     â”‚      Protected API"â”‚                     â”‚                     â”‚                     â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 24. Get Token       â”‚                     â”‚                     â”‚
     â”‚                    â”‚     (with auto      â”‚                     â”‚                     â”‚
     â”‚                    â”‚     refresh check)  â”‚                     â”‚                     â”‚
     â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                     â”‚                     â”‚
     â”‚                    â”‚        â”‚            â”‚                     â”‚                     â”‚
     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 25. GET /api/protected                    â”‚                     â”‚
     â”‚                    â”‚ Authorization: Bearer <token>             â”‚                     â”‚
     â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚ 26. Extract Token   â”‚
     â”‚                    â”‚                     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
     â”‚                    â”‚                     â”‚                     â”‚        â”‚            â”‚
     â”‚                    â”‚                     â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚ 27. Decode Header   â”‚
     â”‚                    â”‚                     â”‚                     â”‚     (get 'kid')     â”‚
     â”‚                    â”‚                     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
     â”‚                    â”‚                     â”‚                     â”‚        â”‚            â”‚
     â”‚                    â”‚                     â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚ 28. GET JWKS Keys   â”‚
     â”‚                    â”‚                     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚ 29. Return Public   â”‚
     â”‚                    â”‚                     â”‚                     â”‚     Keys (RSA)      â”‚
     â”‚                    â”‚                     â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚ 30. Find Matching   â”‚
     â”‚                    â”‚                     â”‚                     â”‚     Key (kid)       â”‚
     â”‚                    â”‚                     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
     â”‚                    â”‚                     â”‚                     â”‚        â”‚            â”‚
     â”‚                    â”‚                     â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚ 31. Verify JWT      â”‚
     â”‚                    â”‚                     â”‚                     â”‚     Signature       â”‚
     â”‚                    â”‚                     â”‚                     â”‚     (RS256)         â”‚
     â”‚                    â”‚                     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
     â”‚                    â”‚                     â”‚                     â”‚        â”‚            â”‚
     â”‚                    â”‚                     â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚ 32. Validate Claims â”‚
     â”‚                    â”‚                     â”‚                     â”‚     - audience      â”‚
     â”‚                    â”‚                     â”‚                     â”‚     - issuer        â”‚
     â”‚                    â”‚                     â”‚                     â”‚     - expiration    â”‚
     â”‚                    â”‚                     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
     â”‚                    â”‚                     â”‚                     â”‚        â”‚            â”‚
     â”‚                    â”‚                     â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚ 33. Extract User    â”‚
     â”‚                    â”‚                     â”‚                     â”‚     Claims          â”‚
     â”‚                    â”‚                     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
     â”‚                    â”‚                     â”‚                     â”‚        â”‚            â”‚
     â”‚                    â”‚                     â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 34. Return 200 OK   â”‚                     â”‚                     â”‚
     â”‚                    â”‚     + User Data     â”‚                     â”‚                     â”‚
     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚  35. Display       â”‚                     â”‚                     â”‚                     â”‚
     â”‚      API Response  â”‚                     â”‚                     â”‚                     â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚  [Time passes - Token approaching expiration]                  â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 36. Check Token Exp â”‚                     â”‚                     â”‚
     â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                     â”‚                     â”‚
     â”‚                    â”‚        â”‚            â”‚                     â”‚                     â”‚
     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 37. acquireTokenSilent                    â”‚                     â”‚
     â”‚                    â”‚     (refresh_token) â”‚                     â”‚                     â”‚
     â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚ 38. Validate Refreshâ”‚                     â”‚
     â”‚                    â”‚                     â”‚     Token           â”‚                     â”‚
     â”‚                    â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                     â”‚
     â”‚                    â”‚                     â”‚        â”‚            â”‚                     â”‚
     â”‚                    â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 39. New Access Tokenâ”‚                     â”‚                     â”‚
     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 40. Update Cache    â”‚                     â”‚                     â”‚
     â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                     â”‚                     â”‚
     â”‚                    â”‚        â”‚            â”‚                     â”‚                     â”‚
     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚  41. Click "Logout"â”‚                     â”‚                     â”‚                     â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 42. Clear Cache     â”‚                     â”‚                     â”‚
     â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                     â”‚                     â”‚
     â”‚                    â”‚        â”‚            â”‚                     â”‚                     â”‚
     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 43. Redirect to     â”‚                     â”‚                     â”‚
     â”‚                    â”‚     /logout         â”‚                     â”‚                     â”‚
     â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚ 44. Clear Session   â”‚                     â”‚
     â”‚                    â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                     â”‚
     â”‚                    â”‚                     â”‚        â”‚            â”‚                     â”‚
     â”‚                    â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 45. Redirect Back   â”‚                     â”‚                     â”‚
     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
     â”‚  46. Show Logged   â”‚                     â”‚                     â”‚                     â”‚
     â”‚      Out State     â”‚                     â”‚                     â”‚                     â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                     â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
â”‚  User   â”‚          â”‚ React   â”‚          â”‚ Azure   â”‚          â”‚ Azure   â”‚          â”‚  JWKS   â”‚
â”‚ Browser â”‚          â”‚   SPA   â”‚          â”‚   AD    â”‚          â”‚Functionsâ”‚          â”‚Endpoint â”‚
â”‚         â”‚          â”‚(MSAL.js)â”‚          â”‚  (IDP)  â”‚          â”‚   API   â”‚          â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ **Simplified Flow Summary**

```
User Browser              Application              Entra ID              Azure Functions
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚â”€â”€â”€â”€â”€ Navigate â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚<â”€â”€â”€â”€ Show Login â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚â”€â”€â”€â”€â”€ Click Login â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚                         â”‚â”€â”€ Generate PKCE â”€â”€>   â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚â•â•â•â•â•â•â•â•â•â•â• Redirect with code_challenge â•â•â•â•â•â•â•>â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚<â•â•â•â•â•â•â•â• Show Login Page â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚â•â•â•â•â•â•â• Enter Credentials â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•> â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚                         â”‚                       â”‚â”€â”€ Authenticate â”€â”€>    â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚<â•â•â•â• Redirect with Auth Code â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚                         â”‚â”€â”€ POST /token â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
     â”‚                         â”‚   (code + verifier)   â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚                         â”‚                       â”‚â”€â”€ Verify PKCE â”€â”€>     â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚                         â”‚<â”€ Return Tokens â”€â”€â”€â”€â”€â”€â”‚                       â”‚
     â”‚                         â”‚   (access, id, refresh)                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚                         â”‚â”€â”€ Cache Tokens â”€â”€>    â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚<â”€â”€â”€ Show Logged In â”€â”€â”€â”€â”€â”‚                       â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚â”€â”€â”€ Call Protected API â”€>â”‚                       â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚                         â”‚â”€â”€â”€â”€ GET /api/protected (Bearer token) â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚â”€â”€ Verify JWT â”€â”€>
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚<â”€ Valid â”€â”€â”€â”€â”€â”€â”€â”€
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚                         â”‚<â”€â”€â”€â”€â”€ 200 OK + User Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚<â”€â”€â”€ Display Response â”€â”€â”€â”‚                       â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚                    [Token Refresh Cycle]        â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚                         â”‚â”€â”€ Silent Refresh â”€â”€â”€â”€>â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚                         â”‚<â”€ New Access Token â”€â”€â”€â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚â”€â”€â”€ Click Logout â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚                         â”‚â”€â”€ Clear Cache â”€â”€>     â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚                         â”‚â”€â”€ /logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚                         â”‚<â”€ Redirect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
     â”‚<â”€â”€â”€ Show Logged Out â”€â”€â”€â”€â”‚                       â”‚                       â”‚
     â”‚                         â”‚                       â”‚                       â”‚
```

---

## ğŸ¯ **Key Message Flows**

### **1. Login Flow (Steps 1-22)**
```
User â†’ SPA: Click Login
SPA â†’ SPA: Generate PKCE (code_verifier, code_challenge)
SPA â†’ Azure AD: Redirect with code_challenge
Azure AD â†’ User: Show Login Page
User â†’ Azure AD: Enter Credentials
Azure AD â†’ Azure AD: Authenticate & Generate Auth Code
Azure AD â†’ SPA: Redirect with Auth Code
SPA â†’ Azure AD: POST /token (code + code_verifier)
Azure AD â†’ Azure AD: Verify PKCE (SHA256(verifier) == challenge)
Azure AD â†’ SPA: Return Tokens (access, id, refresh)
SPA â†’ SPA: Cache Tokens
SPA â†’ User: Show Logged In State
```

### **2. API Call Flow (Steps 23-35)**
```
User â†’ SPA: Click "Call API"
SPA â†’ SPA: Get Access Token from Cache
SPA â†’ API: GET /protected (Authorization: Bearer <token>)
API â†’ API: Extract & Decode Token
API â†’ JWKS: Fetch Public Keys
JWKS â†’ API: Return RSA Public Keys
API â†’ API: Verify Signature (RS256)
API â†’ API: Validate Claims (aud, iss, exp)
API â†’ API: Extract User Info
API â†’ SPA: 200 OK + User Data
SPA â†’ User: Display Response
```

### **3. Token Refresh Flow (Steps 36-40)**
```
SPA â†’ SPA: Check Token Expiration (< 5 min remaining)
SPA â†’ Azure AD: POST /token (grant_type=refresh_token)
Azure AD â†’ Azure AD: Validate Refresh Token
Azure AD â†’ SPA: Return New Access Token
SPA â†’ SPA: Update Token Cache
```

### **4. Logout Flow (Steps 41-46)**
```
User â†’ SPA: Click Logout
SPA â†’ SPA: Clear Token Cache
SPA â†’ Azure AD: Redirect to /logout
Azure AD â†’ Azure AD: Clear Session
Azure AD â†’ SPA: Redirect Back to App
SPA â†’ User: Show Logged Out State
```

---

## ğŸ“Š **Actor Roles**

| Actor | Role | Responsibilities |
|-------|------|------------------|
| **User Browser** | End user interface | Initiates actions, displays UI, stores cookies |
| **React SPA (MSAL.js)** | Authentication client | PKCE generation, token management, API calls |
| **Azure AD (IDP)** | Identity provider | User authentication, token issuance, session management |
| **Azure Functions API** | Resource server | JWT validation, protected resource access |
| **JWKS Endpoint** | Public key provider | RSA public keys for signature verification |

---

## ğŸ” **Security Checkpoints**

```
Checkpoint 1: PKCE Generation (Step 6)
â”œâ”€ Generate random code_verifier (128 chars)
â””â”€ Compute code_challenge = SHA256(code_verifier)

Checkpoint 2: State Parameter (Step 7)
â”œâ”€ Generate random state value
â””â”€ Validate on callback (CSRF protection)

Checkpoint 3: PKCE Verification (Step 17)
â”œâ”€ Azure AD: SHA256(code_verifier) == stored code_challenge
â””â”€ Only proceed if match âœ…

Checkpoint 4: JWT Signature (Step 31)
â”œâ”€ Verify signature with Azure AD public key
â””â”€ Cryptographic proof of authenticity

Checkpoint 5: Claims Validation (Step 32)
â”œâ”€ audience: Must be API client_id
â”œâ”€ issuer: Must be Azure AD tenant
â””â”€ expiration: Must be > current time
```

---

## â±ï¸ **Timing & Performance**

```
Login Flow: ~2-5 seconds
â”œâ”€ User Authentication: 1-3 seconds
â”œâ”€ Token Exchange: 500ms - 1 second
â””â”€ Token Caching: <100ms

API Call: ~200-500ms (first call)
â”œâ”€ Token Retrieval: <50ms (from cache)
â”œâ”€ HTTP Request: 100-300ms
â””â”€ JWT Validation: 50-150ms

API Call: ~100-300ms (subsequent)
â”œâ”€ JWKS Cached: 0ms (24h TTL)
â””â”€ Validation Faster: 10-50ms

Token Refresh: ~500ms - 1 second
â”œâ”€ Silent (background): No user impact
â””â”€ Automatic: Triggered before expiry
```

---

## ğŸ¯ **Message Types Legend**

```
â”€â”€â”€â”€â”€>  Synchronous Request/Action
<â”€â”€â”€â”€â”€  Synchronous Response
â•â•â•â•â•>  Redirect/Navigation (Browser)
<â•â•â•â•â•  Redirect/Navigation Response
â”€â”€â”€â”€â”   Self-processing/Internal operation
    â”‚
<â”€â”€â”€â”˜
```

---

**Created:** November 13, 2025  
**For:** Azure AD Authentication Demo  
**Format:** Traditional Vertical Sequence Diagram  
**Author:** GitHub Copilot Assistant
